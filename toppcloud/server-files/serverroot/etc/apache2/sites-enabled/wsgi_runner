<VirtualHost 127.0.0.1:8080>
	ServerAdmin webmaster@localhost

	#DocumentRoot /var/www
	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>
	<Directory /var/www/>
		Options Indexes FollowSymLinks MultiViews
		AllowOverride None
		Order allow,deny
		allow from all
	</Directory>

	#ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
	#<Directory "/usr/lib/cgi-bin">
	#	AllowOverride None
	#	Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
	#	Order allow,deny
	#	Allow from all
	#</Directory>
	
	<LocationMatch />
         # Insert filter
        SetOutputFilter DEFLATE

        # Netscape 4.x has some problems...
        BrowserMatch ^Mozilla/4 gzip-only-text/html

        # Netscape 4.06-4.08 have some more problems
        BrowserMatch ^Mozilla/4\.0[678] no-gzip

        # MSIE masquerades as Netscape, but it is fine
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        # Don't compress images
        SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png)$ no-gzip dont-vary

        # Make sure proxies don't deliver the wrong content
        Header append Vary User-Agent env=!dont-vary
    </LocationMatch>

	ErrorLog /var/log/apache2/error.log

	# Possible values include: debug, info, notice, warn, error, crit,
	# alert, emerg.
	LogLevel warn

	CustomLog /var/log/apache2/access.log combined

# TOPPCloud customizations:
RewriteEngine on

# Strip www. from all (non-https) domains:
RewriteCond %{SERVER_PORT} ^8080$
RewriteCond %{HTTP_HOST} ^www\.(.*)$
RewriteRule (.*) http://%1$1

# Figure out what "site" to map this request to:
RewriteMap hostmap txt:/var/www/hostmap.txt 

RewriteCond ${hostmap:%{HTTP_HOST}|__default__} ^__default__$
RewriteRule . - [PT,E=SITE:${hostmap:notfound|default-notfound}]

# If a hostmap resulted in "disabled" then map that again as a domain
RewriteCond ${hostmap:%{HTTP_HOST}} ^disabled$
RewriteRule . - [PT,E=SITE:${hostmap:disabled|default-disabled}]

RewriteCond %{HTTP_HOST} (.*)
RewriteRule . - [E=SITE:${hostmap:%1}]

# Serve up any static files:
RewriteCond /var/www/%{ENV:SITE}/static%{REQUEST_URI} -f 
RewriteRule . /var/www/%{ENV:SITE}/static%{REQUEST_URI} [L]

# Lastly, setup the WSGI application:
WSGIApplicationGroup %{ENV:SITE}
WSGIProcessGroup general
WSGIDaemonProcess general user=www-data processes=5 threads=1 maximum-requests=200 inactivity-timeout=3600 display-name=wsgi home=/var/www
WSGIPassAuthorization On

WSGIScriptAlias / /var/www/support/master_runner.py

</VirtualHost>

